<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PGI Admin - Parameter Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 p-8">
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg">
        <h2 class="text-2xl font-bold text-slate-800 mb-6 border-b pb-2">Consortium Admin Panel</h2>
        
        <div id="login-section" class="space-y-4 max-w-md mx-auto">
            <input type="password" id="adminPass" placeholder="Enter Admin Password" class="w-full p-2 border rounded">
            <button onclick="login()" class="w-full bg-slate-800 text-white p-2 rounded hover:bg-slate-700">Login</button>
        </div>

        <div id="admin-controls" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <div class="space-y-4">
                <h3 class="font-bold text-emerald-700 border-b">Economic Baselines</h3>
                <div>
                    <label class="block text-sm font-bold">Minimum Margin (%)</label>
                    <input type="number" id="marginInput" step="0.01" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-bold">Cert. Defaults (€/ha)</label>
                    <input type="number" id="certDefaultInput" step="0.01" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-bold">Reference Yield (kg/ha)</label>
                    <input type="number" id="refYieldInput" step="1" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-bold">Min Consortium Price (€)</label>
                    <input type="number" id="minPriceInput" step="0.01" class="w-full p-2 border rounded">
                </div>
            </div>

            <div class="space-y-6">
                
                <div>
                    <h3 class="font-bold text-emerald-700 border-b mb-2">Quality Adjustments (€/kg)</h3>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="text-xs">Class A</label>
                            <input type="number" id="qualityA" step="0.01" class="w-full p-1 border rounded">
                        </div>
                        <div>
                            <label class="text-xs">Class B</label>
                            <input type="number" id="qualityB" step="0.01" class="w-full p-1 border rounded">
                        </div>
                        <div>
                            <label class="text-xs">Class C</label>
                            <input type="number" id="qualityC" step="0.01" class="w-full p-1 border rounded">
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="font-bold text-emerald-700 border-b mb-2">Risk Premiums</h3>
                    <div class="text-xs text-gray-500 mb-2">Premiums for Normal, Mild, Severe, Extreme years</div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs">Normal (Ratio >= 0.9)</label>
                            <input type="number" id="riskPrem0" step="0.01" class="w-full p-1 border rounded">
                        </div>
                        <div>
                            <label class="text-xs">Mild (Ratio >= 0.7)</label>
                            <input type="number" id="riskPrem1" step="0.01" class="w-full p-1 border rounded">
                        </div>
                        <div>
                            <label class="text-xs">Severe (Ratio >= 0.5)</label>
                            <input type="number" id="riskPrem2" step="0.01" class="w-full p-1 border rounded">
                        </div>
                        <div>
                            <label class="text-xs">Extreme (Ratio < 0.5)</label>
                            <input type="number" id="riskPrem3" step="0.01" class="w-full p-1 border rounded">
                        </div>
                    </div>
                </div>
            </div>

            <div class="md:col-span-2 pt-4">
                <button onclick="updateParams()" class="w-full bg-emerald-600 text-white font-bold p-3 rounded hover:bg-emerald-700 shadow-md">
                    Save Global Parameters
                </button>
            </div>
        </div>
    </div>

<script>
    const API_BASE_URL = "https://hazelnut.onrender.com";

    async function login() {
        const password = document.getElementById('adminPass').value;
        try {
            const response = await fetch(`${API_BASE_URL}/admin/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password }),
                credentials: 'include'
            });

            if (response.ok) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('admin-controls').classList.remove('hidden');
                loadCurrentParams(); 
            } else {
                alert('Invalid Password');
            }
        } catch (e) { alert("Backend offline"); }
    }

    async function loadCurrentParams() {
		const response = await fetch(`${API_BASE_URL}/admin/parameters`, {
			credentials: 'include' // This tells the browser to send the "key"
		});
    
		if (response.status === 401) {
			alert("Session expired. Please log in again.");
			return;
		}

		const p = await response.json();
		
        // Economics
        document.getElementById('marginInput').value = p.min_margin_pct;
        document.getElementById('certDefaultInput').value = p.certification_defaults_ha;
        document.getElementById('refYieldInput').value = p.reference_yield_kg_ha;
        document.getElementById('minPriceInput').value = p.min_consortium_price;

        // Quality
        document.getElementById('qualityA').value = p.quality_table.A;
        document.getElementById('qualityB').value = p.quality_table.B;
        document.getElementById('qualityC').value = p.quality_table.C;

        // Risk Premiums
        document.getElementById('riskPrem0').value = p.risk_table.premiums[0];
        document.getElementById('riskPrem1').value = p.risk_table.premiums[1];
        document.getElementById('riskPrem2').value = p.risk_table.premiums[2];
        document.getElementById('riskPrem3').value = p.risk_table.premiums[3];
    }

    async function updateParams() {
        const newParams = {
            min_margin_pct: parseFloat(document.getElementById('marginInput').value),
            certification_defaults_ha: parseFloat(document.getElementById('certDefaultInput').value),
            reference_yield_kg_ha: parseFloat(document.getElementById('refYieldInput').value),
            min_consortium_price: parseFloat(document.getElementById('minPriceInput').value),
            quality_table: {
                A: parseFloat(document.getElementById('qualityA').value),
                B: parseFloat(document.getElementById('qualityB').value),
                C: parseFloat(document.getElementById('qualityC').value)
            },
            risk_table: {
                thresholds: [0.90, 0.70, 0.50], 
                premiums: [
                    parseFloat(document.getElementById('riskPrem0').value),
                    parseFloat(document.getElementById('riskPrem1').value),
                    parseFloat(document.getElementById('riskPrem2').value),
                    parseFloat(document.getElementById('riskPrem3').value)
                ]
            }
        };

        const res = await fetch(`${API_BASE_URL}/admin/parameters`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newParams),
            credentials: 'include'
        });

        if (res.ok) alert("✅ Saved!");
        else alert("❌ Error saving.");
    }
</script>
</body>
</html>